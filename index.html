<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Calendar — February 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"Medication Calendar 2026\",
        \"short_name\": \"MedCal\",
        \"start_url\": \".\",
        \"display\": \"standalone\",
        \"background_color\": \"#f8f9fa\",
        \"theme_color\": \"#4c5ab8\",
        \"icons\": [
            {
            \"src\": \"https://via.placeholder.com/192?text=MC\",
            \"sizes\": \"192x192\",
            \"type\": \"image/png\"
            }
        ]
        }">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background:#f8f9fa;
            min-height:100vh;
        }
        .container { max-width:1600px; margin:0 auto; padding:40px 20px; }
        .header {
            text-align:center; margin-bottom:40px; padding:30px 20px;
            background:linear-gradient(135deg, #4c5ab8 0%, #5e3a8c 100%);
            border-radius:20px; color:white; box-shadow:0 10px 40px rgba(76,90,184,0.3);
        }
        .title {
            font-family:'Playfair Display',serif; font-size:3.4rem; font-weight:700;
            margin-bottom:6px; letter-spacing:-0.5px;
        }
        .subtitle { font-size:1.3rem; font-weight:400; letter-spacing:3px; text-transform:uppercase; }
        .header-buttons { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:24px; }
        .header-btn {
            background:rgba(255,255,255,0.97); border:2px solid #4c5ab8; color:#1f2937;
            padding:12px 26px; border-radius:50px; font-weight:600; cursor:pointer;
            transition:all 0.3s; box-shadow:0 4px 14px rgba(0,0,0,0.16);
        }
        .header-btn:hover { background:white; transform:translateY(-2px); box-shadow:0 8px 28px rgba(0,0,0,0.26); }
        .header-btn.active { background:white; color:#4c5ab8; border-color:#4c5ab8; }
        .export-btn { background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); border:none; color:white; }
        .export-btn:hover { background:linear-gradient(135deg,#f5576c 0%,#f093fb 100%); }

        .calendar-wrapper { background:white; border-radius:20px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,0.1); }
        .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; background:#e9ecef; border:2px solid #e9ecef; border-radius:12px; overflow:hidden; }
        .day-header { background:linear-gradient(135deg,#5e72e4 0%,#825ee4 100%); color:white; padding:20px 10px; text-align:center; font-weight:700; font-size:0.95rem; }
        .day-cell { background:white; padding:16px; min-height:220px; position:relative; transition:all 0.3s; }
        .day-cell:hover { background:#f8f9ff; transform:translateY(-2px); box-shadow:0 8px 25px rgba(94,114,228,0.15); }
        .edit-mode-active .day-cell { cursor:pointer; border:2px dashed #cbd5e0; }
        .edit-mode-active .day-cell:hover { border-color:#667eea; background:#e8eaff; }
        .edit-indicator { position:absolute; top:8px; left:8px; background:#667eea; color:white; padding:4px 8px; border-radius:4px; font-size:0.7rem; font-weight:700; z-index:2; }

        .period-marker {
            position:absolute; right:12px; padding:5px 11px; border-radius:16px; font-size:0.78rem; font-weight:700;
            color:white; box-shadow:0 3px 10px rgba(0,0,0,0.25); z-index:1;
        }
        .period-marker.pd   { top:12px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .period-marker.dd   { top:42px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:1000; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; border-radius:20px; padding:30px; max-width:600px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:2px solid #e9ecef; flex-wrap:wrap; gap:10px; }
        .close-btn { background:none; border:none; font-size:2.2rem; color:#cbd5e0; cursor:pointer; transition:all 0.2s; }
        .close-btn:hover { color:#667eea; transform:rotate(90deg); }
        .pd-controls button {
            padding:8px 16px;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            color:white;
        }
        .set-pd-btn { background:#10b981; }
        .remove-pd-btn { background:#ef4444; }
        .med-form-item { background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:15px; border-left:4px solid #667eea; }
        .form-group { margin-bottom:15px; }
        .form-label { font-weight:600; color:#2d3748; margin-bottom:8px; display:block; }
        .form-select { width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-size:1rem; }
        .remove-med-btn { background:#f56565; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; }
        .add-med-btn, .save-edit-btn { width:100%; padding:14px; border:none; border-radius:10px; font-weight:600; cursor:pointer; margin-top:15px; }
        .add-med-btn { background:#e2e8f0; color:#2d3748; }
        .save-edit-btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
        .med-list { display:flex; flex-direction:column; gap:10px; }
        .med-item { display:flex; gap:10px; padding:10px; background:#f8f9fa; border-radius:10px; border-left:4px solid; }
        .med-item.maxinion { border-left-color:#4db6ac; }
        .med-item.brotin    { border-left-color:#ffab91; }
        .med-item.aldactone { border-left-color:#b39ddb; }
        .med-item.diane-35  { border-left-color:#f9a8d4; }
        .checkbox { width:22px; height:22px; border:2.5px solid #cbd5e0; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .checkbox.checked { background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%); border-color:#11998e; }
        .checkbox.checked::after { content:'✓'; color:white; font-size:14px; font-weight:bold; }
        @media (max-width: 768px) {
            .container { padding: 16px 12px; }
            .header { padding: 20px 12px; border-radius: 12px; }
            .title { font-size: 2.1rem; margin-bottom: 8px; }
            .subtitle { font-size: 1rem; letter-spacing: 1.5px; }
            .header-buttons { flex-direction: column; gap: 12px; }
            .header-btn {
                width: 100%;
                max-width: 360px;
                padding: 14px 20px;
                font-size: 1.05rem;
            }
            .calendar {
                grid-template-columns: 1fr;
                gap: 16px;
                background: transparent;
                border: none;
            }
            .day-header { display: none; }
            .day-cell {
                min-height: 140px;
                padding: 12px;
                border-radius: 12px;
                box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            }
            .day-number { font-size: 2rem; }
            .day-counter { font-size: 0.9rem; }
            .period-marker {
                font-size: 0.82rem;
                padding: 5px 10px;
                right: 8px;
            }
            .period-marker.pd { top: 8px; }
            .period-marker.dd { top: 34px; }
            .med-item {
                font-size: 0.94rem;
                padding: 10px;
                gap: 8px;
            }
            .checkbox { width: 24px; height: 24px; }
            .modal-content { padding: 20px; width: 96%; }
            .add-med-btn, .save-edit-btn { padding: 14px; font-size: 1rem; }
        }
        .auto-save {
            position:fixed; bottom:30px; right:30px; background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);
            color:white; padding:16px 28px; border-radius:50px; opacity:0; transition:opacity 0.3s; pointer-events:none;
            box-shadow:0 8px 30px rgba(17,153,142,0.4);
        }
        .auto-save.show { opacity:1; }
        .empty-day { text-align:center; color:#cbd5e0; font-style:italic; padding:30px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 class="title">Medication Calendar</h1>
        <p class="subtitle">February 2026</p>
        <div class="header-buttons">
            <button class="header-btn" onclick="toggleEditMode()">
                <span id="editBtnText">✏️ Edit Mode</span>
            </button>
            <button class="header-btn export-btn" onclick="exportData()">Export Schedule (JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            <button class="header-btn" onclick="document.getElementById('importFile').click()">Import Schedule</button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar" id="calendar"></div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="editModalTitle">Edit Day</h2>
            <button class="close-btn" onclick="closeEditModal()">×</button>
        </div>
        <div id="medicationForm"></div>
        <button class="add-med-btn" onclick="addMedication()">+ Add Medication</button>
        <button class="save-edit-btn" onclick="saveEdits()">Save Changes</button>
    </div>
</div>

<div class="auto-save" id="autoSave">Saved Successfully</div>

<script>
// ────────────────────────────────────────────────
//  Configuration & State
// ────────────────────────────────────────────────
let pdStartDate = localStorage.getItem('pdStartDate') || null;  // e.g. "2026-02-02" or null

const LOCAL_KEY_MEDS  = 'medicationData_v3';
const LOCAL_KEY_CHECK = 'checkboxStates_v3';
const REMOTE_FILE     = 'schedule.json';

const MEDICATION_OPTIONS = {
    names: ['Maxinion', 'Brotin', 'Aldactone', 'Diane-35'],
    dosages: {
        'Maxinion':   ['10mg', '30mg'],
        'Brotin':     ['½ tab', '1 tab'],
        'Aldactone':  ['½ tab = 50mg'],
        'Diane-35':   ['1 tab']
    },
    times: ['5AM', '10AM', '8PM']
};

let medicationData  = JSON.parse(localStorage.getItem(LOCAL_KEY_MEDS))  || {};
let checkboxStates  = JSON.parse(localStorage.getItem(LOCAL_KEY_CHECK)) || {};
let isEditMode      = false;
let currentEditDate = null;

// One-time auto-load from shared schedule.json when local is empty
if (Object.keys(medicationData).length === 0) {
    fetch(REMOTE_FILE + '?_=' + Date.now())
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(remote => {
            if (remote?.medicationData) {
                medicationData = { ...remote.medicationData };
                localStorage.setItem(LOCAL_KEY_MEDS, JSON.stringify(medicationData));
            }
            if (remote?.checkboxStates) {                     // ← add this block
                checkboxStates = { ...remote.checkboxStates };
                localStorage.setItem(LOCAL_KEY_CHECK, JSON.stringify(checkboxStates));
            }
            if (remote?.pdStartDate) {                        // optional
                pdStartDate = remote.pdStartDate;
                localStorage.setItem('pdStartDate', pdStartDate);
            }

            // ─── ADD THE MESSAGE HERE ───
            if (Object.keys(checkboxStates).length > 0) {
                showMessage('Some doses already marked as taken from shared schedule');
            }


            showMessage('Shared schedule & checks loaded');
            renderCalendar();
        })
        .catch(() => renderCalendar());
} else {
    renderCalendar();
}

// ────────────────────────────────────────────────
//  PD-S / DD Helpers
// ────────────────────────────────────────────────
function setPDStart(dateKey) {
    pdStartDate = dateKey;
    localStorage.setItem('pdStartDate', dateKey);
    showMessage(`PD-S set to ${dateKey}. DD-1 is +2 days.`);
    closeEditModal();
    renderCalendar();
}

function clearPDStart() {
    pdStartDate = null;
    localStorage.removeItem('pdStartDate');
    showMessage('PD-S cleared. No PD/DD markers shown.');
    renderCalendar();
}

// ────────────────────────────────────────────────
//  Core Functions
// ────────────────────────────────────────────────
function saveMedicationData() {
    localStorage.setItem(LOCAL_KEY_MEDS, JSON.stringify(medicationData));
}

function getDayNumber(date) {
    const dayOne = new Date(2026, 0, 31); // Jan 31 = Day 1
    return Math.floor((date - dayOne) / 86400000) + 1;
}

function toggleCheckbox(medId) {
    checkboxStates[medId] = !checkboxStates[medId];
    localStorage.setItem(LOCAL_KEY_CHECK, JSON.stringify(checkboxStates));
    showMessage('✓');
    const el = document.querySelector(`[data-med-id="${medId}"]`);
    if (el) el.classList.toggle('checked', checkboxStates[medId]);
}

function toggleEditMode() {
    isEditMode = !isEditMode;
    document.body.classList.toggle('edit-mode-active', isEditMode);
    document.getElementById('editBtnText').textContent = isEditMode ? '✓ Done' : '✏️ Edit Mode';
    renderCalendar();
}

function openEditModal(dateKey) {
    if (!isEditMode) return;
    currentEditDate = dateKey;
    const date = new Date(dateKey);
    const dateStr = date.toLocaleDateString('en-US', {month:'long', day:'numeric'});
    const dayNum = getDayNumber(date);
    document.getElementById('editModalTitle').innerHTML = 
        `Edit ${dateStr} – Day ${dayNum} ` +
        (pdStartDate === dateKey ?
            `<button class="remove-pd-btn" onclick="clearPDStart()">Remove PD-S</button>` :
            `<button class="set-pd-btn" onclick="setPDStart('${dateKey}')">Set as PD-S</button>`
        );

    renderMedicationForm(medicationData[dateKey] || []);
    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
    currentEditDate = null;
}

function renderMedicationForm(meds) {
    const form = document.getElementById('medicationForm');
    if (meds.length === 0) {
        form.innerHTML = '<p style="text-align:center;color:#64748b;padding:30px 0;">No medications yet</p>';
        return;
    }
    form.innerHTML = meds.map((m, i) => `
        <div class="med-form-item">
            <div class="form-group">
                <label class="form-label">Medicine</label>
                <select class="form-select" data-field="name" data-index="${i}" onchange="updateDosageOptions(${i})">
                    ${MEDICATION_OPTIONS.names.map(n=>`<option ${m.name===n?'selected':''}>${n}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Dosage</label>
                <select class="form-select" id="dosage-${i}" data-field="dosage">
                    ${(MEDICATION_OPTIONS.dosages[m.name]||[]).map(d=>`<option ${m.dosage===d?'selected':''}>${d}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Time</label>
                <select class="form-select" data-field="time">
                    ${MEDICATION_OPTIONS.times.map(t=>`<option ${m.time===t?'selected':''}>${t}</option>`).join('')}
                </select>
            </div>
            <button class="remove-med-btn" onclick="removeMedication(${i})">Remove</button>
            <input type="hidden" data-field="id" value="${m.id}">
        </div>
    `).join('');
}

function updateDosageOptions(idx) {
    const name = document.querySelector(`[data-field="name"][data-index="${idx}"]`).value;
    const sel = document.getElementById(`dosage-${idx}`);
    sel.innerHTML = (MEDICATION_OPTIONS.dosages[name]||[]).map(d=>`<option>${d}</option>`).join('');
}

function addMedication() {
    const meds = medicationData[currentEditDate] || [];
    const id = `m-${currentEditDate}-${Date.now().toString(36)}`;
    meds.push({ name:'Maxinion', dosage:'30mg', time:'8PM', id });
    medicationData[currentEditDate] = meds;
    renderMedicationForm(meds);
}

function removeMedication(idx) {
    let meds = medicationData[currentEditDate] || [];
    meds.splice(idx, 1);
    medicationData[currentEditDate] = meds.length ? meds : undefined;
    if (!meds.length) delete medicationData[currentEditDate];
    renderMedicationForm(meds);
}

function saveEdits() {
    const items = document.querySelectorAll('#medicationForm .med-form-item');
    const newMeds = Array.from(items).map(el => ({
        name:   el.querySelector('[data-field="name"]').value,
        dosage: el.querySelector('[data-field="dosage"]').value,
        time:   el.querySelector('[data-field="time"]').value,
        id:     el.querySelector('[data-field="id"]').value
    }));
    if (newMeds.length) {
        medicationData[currentEditDate] = newMeds;
    } else {
        delete medicationData[currentEditDate];
    }
    saveMedicationData();
    closeEditModal();
    renderCalendar();
    showMessage('Changes saved');
}

// ────────────────────────────────────────────────
//  Export / Import
// ────────────────────────────────────────────────
function exportData() {
    const payload = {
        medicationData,
        checkboxStates,           // ← add this line
        pdStartDate,  // Include PD-S in export
        exported: new Date().toISOString(),
        note: "Medication schedule — February 2026"
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `med-schedule-2026-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            if (data.medicationData) {
                medicationData = { ...data.medicationData };
                saveMedicationData();
            }
            if (data.checkboxStates) {                        // ← add this
                checkboxStates = { ...data.checkboxStates };
                localStorage.setItem(LOCAL_KEY_CHECK, JSON.stringify(checkboxStates));
            }
            if (data.pdStartDate) {
                pdStartDate = data.pdStartDate;
                localStorage.setItem('pdStartDate', pdStartDate);
            }
            renderCalendar();
            showMessage('Schedule imported');
        } catch (err) {
            alert('Invalid file');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
}

function showMessage(text, ms=1600) {
    const el = document.getElementById('autoSave');
    el.textContent = text;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), ms);
}

// ────────────────────────────────────────────────
//  Calendar render
// ────────────────────────────────────────────────
function renderCalendar() {
    const cal = document.getElementById('calendar');
    let html = '';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html += `<div class="day-header">${d}</div>`);

    for (let d=1; d<=28; d++) {
        const date = new Date(2026, 1, d);
        const key = date.toISOString().split('T')[0];
        const meds = medicationData[key] || [];
        const dayNum = getDayNumber(date);
        const click = isEditMode ? `onclick="openEditModal('${key}')"` : '';

        html += `<div class="day-cell" ${click}>`;
        if (isEditMode) html += `<div class="edit-indicator">EDIT</div>`;

        // Dynamic PD / DD markers based on chosen PD-S date
        if (pdStartDate) {
            const pdStart = new Date(pdStartDate);
            const current = new Date(key);

            const pdDiff = Math.floor((current - pdStart) / 86400000);
            if (pdDiff >= 0 && pdDiff <= 22) {   // 23 days total: PD-S to PD-23
                const label = pdDiff === 0 ? 'PD-S' : `PD-${pdDiff + 1}`;
                html += `<div class="period-marker pd">${label}</div>`;
            }

            const ddStart = new Date(pdStart);
            ddStart.setDate(ddStart.getDate() + 2);  // DD-1 = PD-S + 2 days

            const ddDiff = Math.floor((current - ddStart) / 86400000);
            if (ddDiff >= 0 && ddDiff <= 20) {
                html += `<div class="period-marker dd">DD-${ddDiff + 1}</div>`;
            }
        }

        // Get short month name (e.g. "Feb")
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });

        // Build the day display with month
        html += `
            <div class="day-header-content">
                <div class="day-number">${monthName} ${d}</div>
                <div class="day-counter">Day ${dayNum}</div>
            </div>`;

        if (meds.length === 0) {
            html += `<div class="empty-day">No medications</div>`;
        } else {
            html += `<div class="med-list">`;
            meds.forEach(m => {
                const checked = checkboxStates[m.id] ? 'checked' : '';
                const cls = m.name.toLowerCase().replace(/[^a-z]/g,'-');
                html += `
                    <div class="med-item ${cls}">
                        <div class="checkbox ${checked}" data-med-id="${m.id}" onclick="toggleCheckbox('${m.id}')"></div>
                        <div class="med-details">
                            <div class="med-name">${m.name}</div>
                            <div class="med-info">
                                <span class="med-dose">${m.dosage}</span>
                                <span class="med-time">${m.time}</span>
                            </div>
                        </div>
                    </div>`;
            });
            html += `</div>`;
        }
        html += `</div>`;
    }
    cal.innerHTML = html;
}

// ─── Initial render ───
renderCalendar();
</script>
</body>
</html>